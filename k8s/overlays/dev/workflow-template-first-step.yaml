apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: first-step-workflow-template
  labels:
    tags.datadoghq.com/env: "dev"
spec:
  entrypoint: first-step-job
  templates:
    - name: main
      steps:
        - - name: first-step-job
            template: first-step-job
        - - name: generate-parameter
            template: whalesay
        - - name: consume-parameter
            template: print-message
            arguments:
              parameters:
                - name: message
                  value: "{{steps.generate-parameter.outputs.parameters.hello-param}}"

    - name: whalesay
      container:
        image: docker/whalesay:latest
        command: [ sh, -c ]
        args: [ "sleep 1; echo -n hello world > /tmp/hello_world.txt" ]
        outputs:
          parameters:
            - name: hello-param
              valueFrom:
                default: "Foobar"   # Default value to use if retrieving valueFrom fails. If not provided workflow will fail instead
                path: /tmp/hello_world.txt
    - name: first-step-job
      serviceAccountName: argocd
      container:
        resources:
          requests:
            cpu: 750m
            memory: 64Mi
          limits:
            cpu: 1000m
            memory: 64Mi
        restartPolicy: Never
        name: first-step-container
        image: asia-northeast1-docker.pkg.dev/planet-4f7c6/gke-argocd/first-step
        command:
          - "./first-batch"